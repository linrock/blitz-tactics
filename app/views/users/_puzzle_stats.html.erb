<div class="stats">

  <% if @user.all_time_high_scores? %>
    <div class="all-time-high-scores">
      <h2>All-time stats</h2>

      <div class="unique-puzzles-stat">
        <div class="stats-row total">
          <div class="long-label">Unique puzzles solved</div>
          <div class="count"><%= @user.unique_puzzles_solved_count %></div>
        </div>
      </div>

      <div class="training-mode-stats">
        <div class="all-time-stats-columns">
          <div class="left-column">
            <div class="stats-rows">
              <% if @user.num_haste_rounds_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Haste rounds</div>
                  <div class="count"><%= @user.num_haste_rounds_completed %></div>
                </div>
              <% end %>

              <% if @user.num_three_rounds_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Three rounds</div>
                  <div class="count"><%= @user.num_three_rounds_completed %></div>
                </div>
              <% end %>

              <% if @user.num_mate_in_one_rounds_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Mate-in-one rounds</div>
                  <div class="count"><%= @user.num_mate_in_one_rounds_completed %></div>
                </div>
              <% end %>

              <% if @user.num_rook_endgames_rounds_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Rook endgames rounds</div>
                  <div class="count"><%= @user.num_rook_endgames_rounds_completed %></div>
                </div>
              <% end %>

              <% if @user.num_openings_rounds_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Openings rounds</div>
                  <div class="count"><%= @user.num_openings_rounds_completed %></div>
                </div>
              <% end %>
            </div>
          </div>
          
          <div class="right-column">
            <div class="stats-rows">
              <% if @user.num_infinity_puzzles_solved > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Infinity puzzles</div>
                  <div class="count"><%= @user.num_infinity_puzzles_solved %></div>
                </div>
              <% end %>

              <% if @user.num_countdowns_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Countdown levels</div>
                  <div class="count"><%= @user.num_countdowns_completed %></div>
                </div>
              <% end %>

              <% if @user.num_speedruns_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Speedrun levels</div>
                  <div class="count"><%= @user.num_speedruns_completed %></div>
                </div>
              <% end %>

              <% if @user.num_repetition_levels_completed > 0 %>
                <div class="stats-row total">
                  <div class="long-label">Repetition levels</div>
                  <div class="count"><%= @user.num_repetition_levels_completed %></div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="activity-feed">
        <h2>Recent activity</h2>
    <% recent_activities = @user.recent_activity(10) %>
    <% if recent_activities.any? %>
      <div class="activity-list">
        <% recent_activities.each do |activity| %>
          <div class="activity-item">
            <div class="activity-date">
              <%= activity[:date].strftime("%b %d, %Y") %>
            </div>
            <a href="<%= activity[:url] %>" class="activity-game-mode">
              <%= activity[:type_display] %>
            </a>
            <div class="activity-score">
              <%= activity[:score] %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="no-activity">
        No recent activity in the past 30 days.
      </div>
    <% end %>
  </div>

  <% daily_stats = @user.daily_puzzle_solves_past_7_days %>
  <% total_puzzles = daily_stats.sum { |day| day[:count] } %>
  <% if total_puzzles > 0 %>
    <div class="daily-puzzle-graph">
      <h2>Unique puzzles solved</h2>
      <% max_count = daily_stats.map { |day| day[:count] }.max || 1 %>
      <div class="graph-container">
        <div class="graph-bars">
          <% daily_stats.each do |day| %>
            <div class="graph-bar-container">
              <div class="graph-bar" 
                   style="height: <%= (day[:count].to_f / max_count * 100).round(1) %>%"
                   title="<%= day[:formatted_date] %>: <%= day[:count] %> puzzle<%= 's' if day[:count] != 1 %>">
                <div class="bar-value"><%= day[:count] %></div>
              </div>
              <div class="bar-label">
                <div class="day-name"><%= day[:day_name] %></div>
                <div class="day-date"><%= day[:formatted_date] %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if @recent_puzzles.any? %>
    <div class="recent-puzzles-section">
             <h2>Recent puzzles solved</h2>
      <div class="recent-puzzles-list">
        <% @recent_puzzles.each do |puzzle_data| %>
          <% puzzle = puzzle_data[:puzzle] %>
          <% solution_lines = puzzle_data[:solution_lines] %>
          <% solved_at = puzzle_data[:solved_at] %>
          <% game_mode = puzzle_data[:game_mode] %>
          <div class="recent-puzzle-item" data-puzzle-id="<%= puzzle.puzzle_id %>">
            <div class="puzzle-miniboard">
              <%= linked_puzzle_miniboard(puzzle) %>
            </div>
            <div class="puzzle-timestamp">
              <%= time_ago_in_words(solved_at) %> ago
            </div>
            <% if game_mode.present? %>
              <div class="puzzle-game-mode">
                <%= case game_mode
                    when 'mate_in_one' then 'Mate in one'
                    when 'rook_endgames' then 'Rook endgames'
                    else game_mode.capitalize
                    end %>
              </div>
            <% end %>
            <button class="view-solution-btn"
                    data-puzzle-id="<%= puzzle.puzzle_id %>"
                    data-initial-fen="<%= puzzle.initial_fen %>"
                    data-solution-lines="<%= solution_lines.to_json %>">
              Show solution
            </button>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @user.hall_of_famer? %>
    <div class="achievements">
      <h4>Hall of famer</h4>
      <div>Solved all 65 original repetition levels</div>
    </div>
  <% end %>

  <% if @user.recent_high_scores? %>
    <div class="recent-high-scores">
      <h2>Recent high scores</h2>
      
      <div class="recent-scores-columns">
        <div class="left-column">
          <% if @user.num_countdowns_completed > 0 %>
            <div class="game-mode-stats">
              <h3 class="game-mode-name"><a href="/countdown">Countdown</a></h3>
              <div class="stats-rows">
                <% @user.countdown_stats.each do |row| %>
                  <div class="stats-row">
                    <div class="label"><%= row[0].capitalize %></div>
                    <div class="count"><%= row[1] %></div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @user.num_speedruns_completed > 0 %>
            <div class="game-mode-stats">
              <h3 class="game-mode-name"><a href="/speedrun">Speedrun</a></h3>
              <div class="stats-rows">
                <% @user.speedrun_stats.each do |row| %>
                  <div class="stats-row">
                    <div class="label"><%= row[0].capitalize %></div>
                    <div class="count"><%= row[1] %></div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        
        <div class="right-column">
          <% if @user.num_infinity_puzzles_solved > 0 %>
            <div class="game-mode-stats">
              <h3 class="game-mode-name"><a href="/infinity">Infinity</a></h3>
              <div class="stats-rows">
                <% @user.infinity_puzzles_solved_by_difficulty.each do |difficulty, count| %>
                  <% if count > 0 %>
                    <div class="stats-row">
                      <div class="label"><%= difficulty.capitalize %></div>
                      <div class="count"><%= count %></div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @user.user_rating&.rated_puzzle_attempts&.count.to_i > 0 %>
            <div class="game-mode-stats">
              <h3 class="game-mode-name"><a href="/rated">Rated</a></h3>
              <div class="stats-rows">
                <div class="stats-row">
                  <div class="label">Rating</div>
                  <div class="count"><%= @user.user_rating&.rating.round %></div>
                </div>
                <div class="stats-row">
                  <div class="label">Puzzles seen</div>
                  <div class="count"><%= @user.user_rating&.rated_puzzle_attempts&.count %></div>
                </div>
              </div>
            </div>
          <% end %>

          <% if @user.num_repetition_levels_completed > 0 %>
            <div class="game-mode-stats">
              <h3 class="game-mode-name"><a href="/repetition">Repetition</a></h3>
              <div class="stats-rows">
                <% @user.repetition_stats.each do |repetition_level, time| %>
                  <div class="stats-row">
                    <div class="label">
                      <% if current_user and repetition_level.number <= current_user.highest_repetition_level_number_completed %>
                        <%= link_to "Level #{repetition_level.number}", repetition_level.path %>
                      <% else %>
                        Level <%= repetition_level.number %>
                      <% end %>
                    </div>
                    <div class="count"><%= time %></div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>


</div>
